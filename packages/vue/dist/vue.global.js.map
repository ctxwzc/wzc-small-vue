{
  "version": 3,
  "sources": ["../src/index.ts", "../../shared/src/index.ts", "../../reactivity/src/dep.ts", "../../reactivity/src/effect.ts", "../../reactivity/src/reactive.ts"],
  "sourcesContent": ["\r\nexport * from \"@vue/runtime-core\";", "export const isArray = Array.isArray", "import { ReactiveEffect } from \"./effect\";\r\n\r\nexport type Dep = Set<ReactiveEffect>\r\n\r\nexport const createDep = (effects?: ReactiveEffect[]): Dep => {\r\n    const dep = new Set<ReactiveEffect>(effects) as Dep\r\n    return dep\r\n}", "import { isArray } from \"@vue/shared\";\r\nimport { createDep, Dep } from \"./dep\";\r\n\r\n/**\r\n * 1. targetMap\u5B58\u50A8{target -> key -> dep}\u7684\u5173\u7CFB\u3002\r\n * 2. \u8FD9\u91CC\u4F7F\u7528weakmap\u5E94\u8BE5\u662F\u7528\u5230weakmap\u5F31\u5F15\u7528\u7279\u6027:\r\n * \u53EA\u8981\u6240\u5F15\u7528\u7684\u5BF9\u8C61\u7684\u5176\u4ED6\u5F15\u7528\u90FD\u88AB\u6E05\u9664\uFF0C\u5783\u573E\u56DE\u6536\u673A\u5236\u5C31\u4F1A\u91CA\u653E\u8BE5\u5BF9\u8C61\u6240\u5360\u7528\u7684\u5185\u5B58\u3002\r\n * \u4E5F\u5C31\u662F\u8BF4\uFF0C\u4E00\u65E6\u4E0D\u518D\u9700\u8981\uFF0CWeakMap \u91CC\u9762\u7684\u952E\u540D\u5BF9\u8C61\u548C\u6240\u5BF9\u5E94\u7684\u952E\u503C\u5BF9\u4F1A\u81EA\u52A8\u6D88\u5931\uFF0C\r\n * \u4E0D\u7528\u624B\u52A8\u5220\u9664\u5F15\u7528\uFF0C\u53C2\u8003\u962E\u4E00\u5CF0ES6\u6307\u5357\r\n */\r\ntype KeyToDepMap = Map<any, Dep>\r\nconst targetMap = new WeakMap<any, KeyToDepMap>()\r\n\r\n//\u5F53\u524D\u6B63\u5728\u6FC0\u6D3B\u7684effect\r\nexport let activeEffect: ReactiveEffect | undefined\r\n\r\n//effect\u7C7B\r\nexport class ReactiveEffect<T = any>{\r\n    deps: Dep[] = [] //\u4F9D\u8D56\u6570\u7EC4\r\n    constructor(\r\n        public fn: () => T\r\n    ) {\r\n\r\n    }\r\n    run() {\r\n        activeEffect = this\r\n        try {\r\n            return this.fn()\r\n        } finally {\r\n            activeEffect = undefined\r\n        }\r\n    }\r\n}\r\n\r\nexport function effect<T = any>(fn: () => T) {\r\n    const _effect = new ReactiveEffect(fn)\r\n    _effect.run()\r\n}\r\n//\u8FFD\u8E2A\u4F9D\u8D56\r\nexport function track(target: object, key: unknown) {\r\n    //\u6CA1\u6709\u6FC0\u6D3B\u7684effect\uFF0C\u8DF3\u8FC7\r\n    if (activeEffect) {\r\n        let depsMap = targetMap.get(target)\r\n        //\u6CA1\u6536\u96C6\u8FC7\u7684\u4F9D\u8D56\uFF0C\u5C31\u6536\u96C6\u8D77\u6765\r\n        if (!depsMap) {\r\n            targetMap.set(target, (depsMap = new Map()))\r\n        }\r\n        let dep = depsMap.get(key)\r\n        if (!dep) {\r\n            depsMap.set(key, (dep = createDep()))\r\n        }\r\n        trackEffects(dep)\r\n    }\r\n}\r\n\r\nexport function trackEffects(dep: Dep) {\r\n    //\u7ED9\u5F53\u524D\u6FC0\u6D3B\u7684effect\u8BBE\u7F6E\u8BA2\u9605\u8005\r\n    //\u5982\u679C\u4E00\u4E2A\u53D8\u91CF\u5728\u5F53\u524D\u8FD0\u884C\u7684\u526F\u4F5C\u7528\u4E2D\u88AB\u8BFB\u53D6\u4E86\uFF0C\u5C31\u5C06\u8BE5\u526F\u4F5C\u7528\u8BBE\u4E3A\u6B64\u53D8\u91CF\u7684\u4E00\u4E2A\u8BA2\u9605\u8005\r\n    dep.add(activeEffect!)\r\n    activeEffect!.deps.push(dep)\r\n}\r\n\r\nexport function trigger(target: object, key: unknown) {\r\n    const depsMap = targetMap.get(target)\r\n    let deps: (Dep | undefined)[] = []\r\n    if (!depsMap) {\r\n        // never been tracked\r\n        return\r\n    }\r\n    if (key != void 0) {\r\n        deps.push(depsMap.get(key))\r\n    }\r\n    if (deps.length === 1) {\r\n        if (deps[0]) {\r\n            triggerEffects(deps[0])\r\n        }\r\n    }\r\n}\r\nexport function triggerEffects(\r\n    dep: Dep | ReactiveEffect[],\r\n) {\r\n    // spread into array for stabilization\r\n    const effects = isArray(dep) ? dep : [...dep]\r\n    for (const effect of effects) {\r\n        triggerEffect(effect)\r\n    }\r\n}\r\nfunction triggerEffect(\r\n    effect: ReactiveEffect,\r\n) {\r\n    if (effect !== activeEffect) {\r\n        effect.run()\r\n    }\r\n}", "import { track, trigger } from \"./effect\"\r\n\r\n//\u8FD4\u56DE\u4E00\u4E2A\u5BF9\u8C61\u7684\u54CD\u5E94\u5F0F\u4EE3\u7406\u3002\r\nexport function reactive(target: object) {\r\n    return createReactiveObject(\r\n        target,\r\n    )\r\n}\r\n\r\n//vue3\u4F7F\u7528proxy\u62E6\u622A\r\nexport function createReactiveObject(\r\n    target: any,\r\n) {\r\n    return new Proxy(target, {\r\n        //get\u65B9\u6CD5\r\n        get: function (target, key, receiver) {\r\n            //\u8FFD\u8E2A\u4F9D\u8D56\r\n            track(target, key)\r\n            return Reflect.get(target, key, receiver)\r\n        },\r\n        set: function (target, key, value, receiver) {\r\n            const result =  Reflect.set(target, key, value, receiver)\r\n            //\u89E6\u53D1\u4F9D\u8D56\r\n            trigger(target,key)\r\n            return result\r\n        }\r\n        //...\u8FD8\u6709\u5176\u4ED6\u7684proxy\u53EF\u4EE5\u62E6\u622A\u7684\u64CD\u4F5C\r\n    })\r\n}"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;ACAO,MAAM,UAAU,MAAM;;;ACItB,MAAM,YAAY,CAAC,YAAoC;AAC1D,UAAM,MAAM,IAAI,IAAoB,OAAO;AAC3C,WAAO;AAAA,EACX;;;ACIA,MAAM,YAAY,oBAAI,QAA0B;AAGzC,MAAI;AAGJ,MAAM,iBAAN,MAA6B;AAAA,IAEhC,YACW,IACT;AADS;AAFX,kBAAc,CAAC;AAAA,IAKf;AAAA,IACA,MAAM;AACF,qBAAe;AACf,UAAI;AACA,eAAO,KAAK,GAAG;AAAA,MACnB,UAAE;AACE,uBAAe;AAAA,MACnB;AAAA,IACJ;AAAA,EACJ;AAEO,WAAS,OAAgB,IAAa;AACzC,UAAM,UAAU,IAAI,eAAe,EAAE;AACrC,YAAQ,IAAI;AAAA,EAChB;AAEO,WAAS,MAAM,QAAgB,KAAc;AAEhD,QAAI,cAAc;AACd,UAAI,UAAU,UAAU,IAAI,MAAM;AAElC,UAAI,CAAC,SAAS;AACV,kBAAU,IAAI,QAAS,UAAU,oBAAI,IAAI,CAAE;AAAA,MAC/C;AACA,UAAI,MAAM,QAAQ,IAAI,GAAG;AACzB,UAAI,CAAC,KAAK;AACN,gBAAQ,IAAI,KAAM,MAAM,UAAU,CAAE;AAAA,MACxC;AACA,mBAAa,GAAG;AAAA,IACpB;AAAA,EACJ;AAEO,WAAS,aAAa,KAAU;AAGnC,QAAI,IAAI,YAAa;AACrB,iBAAc,KAAK,KAAK,GAAG;AAAA,EAC/B;AAEO,WAAS,QAAQ,QAAgB,KAAc;AAClD,UAAM,UAAU,UAAU,IAAI,MAAM;AACpC,QAAI,OAA4B,CAAC;AACjC,QAAI,CAAC,SAAS;AAEV;AAAA,IACJ;AACA,QAAI,OAAO,QAAQ;AACf,WAAK,KAAK,QAAQ,IAAI,GAAG,CAAC;AAAA,IAC9B;AACA,QAAI,KAAK,WAAW,GAAG;AACnB,UAAI,KAAK,IAAI;AACT,uBAAe,KAAK,EAAE;AAAA,MAC1B;AAAA,IACJ;AAAA,EACJ;AACO,WAAS,eACZ,KACF;AAEE,UAAM,UAAU,QAAQ,GAAG,IAAI,MAAM,CAAC,GAAG,GAAG;AAC5C,eAAWA,WAAU,SAAS;AAC1B,oBAAcA,OAAM;AAAA,IACxB;AAAA,EACJ;AACA,WAAS,cACLA,SACF;AACE,QAAIA,YAAW,cAAc;AACzB,MAAAA,QAAO,IAAI;AAAA,IACf;AAAA,EACJ;;;AC1FO,WAAS,SAAS,QAAgB;AACrC,WAAO;AAAA,MACH;AAAA,IACJ;AAAA,EACJ;AAGO,WAAS,qBACZ,QACF;AACE,WAAO,IAAI,MAAM,QAAQ;AAAA,MAErB,KAAK,SAAUC,SAAQ,KAAK,UAAU;AAElC,cAAMA,SAAQ,GAAG;AACjB,eAAO,QAAQ,IAAIA,SAAQ,KAAK,QAAQ;AAAA,MAC5C;AAAA,MACA,KAAK,SAAUA,SAAQ,KAAK,OAAO,UAAU;AACzC,cAAM,SAAU,QAAQ,IAAIA,SAAQ,KAAK,OAAO,QAAQ;AAExD,gBAAQA,SAAO,GAAG;AAClB,eAAO;AAAA,MACX;AAAA,IAEJ,CAAC;AAAA,EACL;",
  "names": ["effect", "target"]
}
